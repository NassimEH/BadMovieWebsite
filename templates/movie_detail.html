{% extends "base.html" %}

{% block title %}BadMovie | {{ movie.title }}{% endblock %}

{% block content %}
<div class="movie-detail-page">
  <header>
    <a href="{{ url_for('index') }}" class="logo">BadMovie<span class="logo-dot">.</span></a>
    <ul class="nav">
      <li><a href="{{ url_for('index') }}" title="Accueil"><i class="fa fa-home" aria-hidden="true"></i></a></li>
      <li><a href="{{ url_for('movies.list_movies') }}">Tous nos films</a></li>
      <li><a href="{{ url_for('watchlist.show_watchlist') }}">Ma Liste</a></li>
      <li><a href="#">Pour vous</a></li>
    </ul>
    <div class="header-right">
      <div class="auth-buttons">
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('auth.logout') }}" class="auth-btn">Déconnexion</a>
        <span class="user-name">{{ current_user.nom }}</span>
        {% else %}
        <a href="{{ url_for('auth.login') }}" class="auth-btn">Connexion</a>
        <a href="{{ url_for('auth.sign_up') }}" class="auth-btn auth-btn-outline">Inscription</a>
        {% endif %}
      </div>
    </div>
  </header>
  
  <div class="movie-detail-hero" {% if backdrop_url %}style="background-image: url('{{ backdrop_url }}');"{% endif %}>
    <div class="movie-detail-overlay"></div>

    <div class="movie-detail-content">
      <div class="movie-detail-poster-section">
        <div class="movie-detail-poster">
          {% if poster_url %}
          <img src="{{ poster_url }}" alt="Affiche de {{ movie.title }}" />
          {% else %}
          <div class="movie-detail-poster-placeholder">
            <span>Aucune affiche</span>
          </div>
          {% endif %}
        </div>

        <div class="movie-detail-user-actions">
          {% if not current_user.is_authenticated %}
          <div class="login-prompt">
            <p><a href="{{ url_for('auth.login') }}">Connectez-vous</a> pour gérer votre liste</p>
          </div>
          {% endif %}

          <div class="movie-watched-toggle">
            <button type="button" id="watched-btn" 
                    class="watched-btn {% if interaction and interaction.watched %}watched{% endif %}" 
                    data-watched="{{ 'true' if interaction and interaction.watched else 'false' }}"
                    {% if not current_user.is_authenticated %}disabled{% endif %}>
              <i class="fa {% if interaction and interaction.watched %}fa-check-circle{% else %}fa-eye{% endif %}" aria-hidden="true"></i>
              <span class="watched-text">
                {% if interaction and interaction.watched %}Vu{% else %}Marquer comme vu{% endif %}
              </span>
            </button>
          </div>

          <div class="movie-rating-section">
            <h3 class="movie-detail-section-title">Ma note</h3>
            
            <div class="star-rating" 
                 data-current-score="{{ interaction.score_user if interaction and interaction.score_user else 0 }}"
                 {% if not current_user.is_authenticated %}data-disabled="true"{% endif %}>
              
              {% for i in range(1, 6) %}
              <div class="star-container" data-rating="{{ i }}">
                <span class="star star-left" data-rating="{{ i - 0.5 }}" aria-label="Noter {{ i - 0.5 }}/5">
                  <i class="fa fa-star-half-o" aria-hidden="true"></i>
                </span>
                <span class="star star-right" data-rating="{{ i }}" aria-label="Noter {{ i }}/5">
                  <i class="fa fa-star-o" aria-hidden="true"></i>
                </span>
              </div>
              {% endfor %}
            </div>

            <div class="rating-display">
              <span class="rating-value">{{ interaction.score_user if interaction and interaction.score_user else 0 }}</span>
              <span class="rating-max">/ 5</span>
            </div>
            <div class="rating-label"></div>
          </div>
        </div>
      </div>

      <div class="movie-detail-info">
        <h1 class="movie-detail-title">{{ movie.title }}</h1>
        <div class="movie-detail-meta">
          {% if movie.release_date %}<span class="meta-item">{{ movie.release_date[:4] }}</span>{% endif %}
          {% if movie.runtime %}<span class="meta-item">{{ movie.runtime }} min</span>{% endif %}
          {% if movie.genres %}<span class="meta-item">{{ movie.genres | map(attribute='name') | join(', ') }}</span>{% endif %}
        </div>

        {% if movie.vote_average %}
        <div class="movie-detail-rating">
          <span class="movie-detail-rating-score">{{ '%.1f'|format(movie.vote_average) }}</span>
          <span class="movie-detail-rating-label">/ 10 sur TMDB</span>
        </div>
        {% endif %}

        <div class="movie-detail-actions">
          <a href="#" class="primary-btn"><i class="fa fa-play" aria-hidden="true"></i> Regarder</a>
          
          {% if interaction %}
            <a href="javascript:void(0)" 
               class="secondary-btn js-watchlist-btn"
               style="opacity: 0.7; pointer-events: none;"
               data-tmdb-id="{{ movie.id }}"
               data-title="{{ movie.title }}"
               data-image="{{ poster_url }}"
               data-release-date="{{ movie.release_date }}"
               data-runtime="{{ movie.runtime }}"
               data-category="{{ movie.genres[0]['name'] if movie.genres else 'Autre' }}">
               <i class="fa fa-check" aria-hidden="true"></i> Dans ma liste
            </a>
          
          {% else %}
            <a href="javascript:void(0)" 
               class="secondary-btn js-watchlist-btn"
               data-tmdb-id="{{ movie.id }}"
               data-title="{{ movie.title }}"
               data-image="{{ poster_url }}"
               data-release-date="{{ movie.release_date }}"
               data-runtime="{{ movie.runtime }}"
               data-category="{{ movie.genres[0]['name'] if movie.genres else 'Autre' }}">
               <i class="fa fa-plus" aria-hidden="true"></i> Ma Liste
            </a>
          {% endif %}
        </div>

        {% if movie.overview %}
        <div class="movie-detail-overview-wrapper">
          <h3 class="movie-detail-section-title">Synopsis</h3>
          <p class="movie-detail-overview">{{ movie.overview }}</p>
        </div>
        {% endif %}

        {% if main_cast %}
        <div class="movie-detail-cast">
          <h3 class="movie-detail-section-title">Avec</h3>
          <p class="movie-detail-cast-list">{{ main_cast | join(', ') }}</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}